---
import Layout from "../layouts/Layout.astro";
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";
import { orderedCategoryKeys } from "../types/exampleCategories";

const isProd = import.meta.env.PROD;

const examples: CollectionEntry<"examples">[] = isProd
  ? (await getCollection("examples")).filter((example) => example.data.visible)
  : await getCollection("examples");

const grouped = examples.reduce((acc, ex) => {
  const category = ex.data.category;
  (acc[category] ??= []).push(ex);
  return acc;
}, {} as Record<string, CollectionEntry<"examples">[]>);

// Sort examples within each category by the ord property
const sortedGrouped: Record<string, CollectionEntry<"examples">[]> = {};
Object.keys(grouped).forEach(category => {
  sortedGrouped[category] = [...grouped[category]].sort((a, b) => {
    const ordA = a.data.ord ?? Infinity; // Treat undefined ord as last
    const ordB = b.data.ord ?? Infinity;
    return ordA - ordB;
  });
});

const categories = orderedCategoryKeys(grouped);
---

<Layout title="Interactive Math Applets" description="A collection of interactive math applets for learning and exploration.">
  <div class="space-y-6 not-prose">
    {
      categories.map((category) => (
        <section>
          <h2 class="text-sm font-bold uppercase tracking-wide text-slate-400 mb-2">
            {category}
          </h2>

          <ul class="space-y-1 list-none">
            {
              sortedGrouped[category].map((ex) => (
                <li>
                   <a
                    href={`${import.meta.env.BASE_URL}/examples/${ex.slug}`}
                    class="flex items-center justify-between py-1 text-slate-900 hover:text-blue-600 group"
                  >
                    <span class="truncate mr-2">{ex.data.title}</span>
                    
                    {/* Status Icons */}
                    <div class="flex-shrink-0">
                      {ex.data.approved && (
                       <svg
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                          fill="currentColor"
                          class="w-4 h-4 text-green-500"
                          aria-label="Approved"
                        >
                          <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clipRule="evenodd" />
                        </svg>
                      )}

                      {!ex.data.approved && (
                        <svg 
                          xmlns="http://www.w3.org/2000/svg" 
                          viewBox="0 0 24 24" 
                          fill="currentColor" 
                          class="w-4 h-4 text-amber-500"
                          aria-label="Pending Approval"
                        >
                          <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25ZM12.75 6a.75.75 0 0 0-1.5 0v6c0 .414.336.75.75.75h4.5a.75.75 0 0 0 0-1.5h-3.75V6Z" clipRule="evenodd" />
                        </svg>
                      )}
                    </div>

                  </a>
                </li>
              ))
            }
          </ul>
        </section>
      ))
    }
  </div>
</Layout>